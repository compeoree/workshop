
# Sorted dome test 2016/06/08 19:01:44

# Frequency: 2
# Radius: 30.0
#Vertices: 36
V = [
	[   0.000,    0.000,   30.000], #  0 0-0
	[  15.772,    0.000,   25.520], #  1 1-0
	[   4.874,   15.000,   25.520], #  2 1-1
	[ -12.760,    9.270,   25.520], #  3 1-2
	[ -12.760,   -9.270,   25.520], #  4 1-3
	[   4.874,  -15.000,   25.520], #  5 1-4
	[  20.646,   15.000,   15.772], #  6 2-0
	[  -7.886,   24.270,   15.772], #  7 2-1
	[ -25.520,    0.000,   15.772], #  8 2-2
	[  -7.886,  -24.270,   15.772], #  9 2-3
	[  20.646,  -15.000,   15.772], # 10 2-4
	[  26.833,    0.000,   13.416], # 11 3-0
	[   8.292,   25.520,   13.416], # 12 3-1
	[ -21.708,   15.772,   13.416], # 13 3-2
	[ -21.708,  -15.772,   13.416], # 14 3-3
	[   8.292,  -25.520,   13.416], # 15 3-4
	[  28.532,    9.270,    0.000], # 16 4-0
	[  17.634,   24.271,    0.000], # 17 4-1
	[   0.000,   30.000,    0.000], # 18 4-2
	[ -17.634,   24.271,    0.000], # 19 4-3
	[ -28.532,    9.271,    0.000], # 20 4-4
	[ -28.532,   -9.270,    0.000], # 21 4-5
	[ -17.634,  -24.271,    0.000], # 22 4-6
	[   0.000,  -30.000,    0.000], # 23 4-7
	[  17.634,  -24.271,    0.000], # 24 4-8
	[  28.532,   -9.270,    0.000], # 25 4-9
	[  21.708,   15.772,  -13.416], # 26 5-0
	[  -8.292,   25.520,  -13.416], # 27 5-1
	[ -26.833,    0.000,  -13.416], # 28 5-2
	[  -8.292,  -25.520,  -13.416], # 29 5-3
	[  21.708,  -15.772,  -13.416], # 30 5-4
	[  25.520,    0.000,  -15.772], # 31 6-0
	[   7.886,   24.271,  -15.772], # 32 6-1
	[ -20.646,   15.000,  -15.772], # 33 6-2
	[ -20.646,  -15.000,  -15.772], # 34 6-3
	[   7.886,  -24.271,  -15.772]  # 35 6-4
        ]

# Edges: 95
E = [
	[ 0,  1,   16.400, "-"], #   0
	[ 1,  2,   18.540, "-"], #   1
	[ 2,  0,   16.400, "-"], #   2
	[ 1, 11,   16.400, "-"], #   3
	[11,  6,   16.400, "-"], #   4
	[ 6,  1,   18.540, "-"], #   5
	[ 6,  2,   18.540, "-"], #   6
	[ 6, 12,   16.400, "-"], #   7
	[12,  2,   16.400, "-"], #   8
	[ 2,  3,   18.540, "-"], #   9
	[ 3,  0,   16.400, "-"], #  10
	[12,  7,   16.400, "-"], #  11
	[ 7,  2,   18.540, "-"], #  12
	[ 7,  3,   18.540, "-"], #  13
	[ 7, 13,   16.400, "-"], #  14
	[13,  3,   16.400, "-"], #  15
	[ 3,  4,   18.540, "-"], #  16
	[ 4,  0,   16.400, "-"], #  17
	[13,  8,   16.400, "-"], #  18
	[ 8,  3,   18.540, "-"], #  19
	[ 8,  4,   18.540, "-"], #  20
	[ 8, 14,   16.400, "-"], #  21
	[14,  4,   16.400, "-"], #  22
	[ 4,  5,   18.540, "-"], #  23
	[ 5,  0,   16.400, "-"], #  24
	[14,  9,   16.400, "-"], #  25
	[ 9,  4,   18.540, "-"], #  26
	[ 9,  5,   18.540, "-"], #  27
	[ 9, 15,   16.400, "-"], #  28
	[15,  5,   16.400, "-"], #  29
	[ 5,  1,   18.540, "-"], #  30
	[15, 10,   16.400, "-"], #  31
	[10,  5,   18.540, "-"], #  32
	[10,  1,   18.540, "-"], #  33
	[10, 11,   16.400, "-"], #  34
	[ 6, 16,   18.540, "-"], #  35
	[16, 11,   16.400, "-"], #  36
	[12, 17,   16.400, "-"], #  37
	[17,  6,   18.540, "-"], #  38
	[17, 16,   18.540, "-"], #  39
	[17, 26,   16.400, "-"], #  40
	[26, 16,   16.400, "-"], #  41
	[17, 18,   18.540, "-"], #  42
	[18, 12,   16.400, "-"], #  43
	[26, 32,   16.400, "-"], #  44
	[32, 17,   18.540, "-"], #  45
	[32, 18,   18.540, "-"], #  46
	[32, 27,   16.400, "-"], #  47
	[27, 18,   16.400, "-"], #  48
	[ 7, 18,   18.540, "-"], #  49
	[13, 19,   16.400, "-"], #  50
	[19,  7,   18.540, "-"], #  51
	[19, 18,   18.540, "-"], #  52
	[19, 27,   16.400, "-"], #  53
	[19, 20,   18.540, "-"], #  54
	[20, 13,   16.400, "-"], #  55
	[27, 33,   16.400, "-"], #  56
	[33, 19,   18.540, "-"], #  57
	[33, 20,   18.540, "-"], #  58
	[33, 28,   16.400, "-"], #  59
	[28, 20,   16.400, "-"], #  60
	[ 8, 20,   18.540, "-"], #  61
	[14, 21,   16.400, "-"], #  62
	[21,  8,   18.540, "-"], #  63
	[21, 20,   18.540, "-"], #  64
	[21, 28,   16.400, "-"], #  65
	[21, 22,   18.540, "-"], #  66
	[22, 14,   16.400, "-"], #  67
	[28, 34,   16.400, "-"], #  68
	[34, 21,   18.540, "-"], #  69
	[34, 22,   18.540, "-"], #  70
	[34, 29,   16.400, "-"], #  71
	[29, 22,   16.400, "-"], #  72
	[ 9, 22,   18.540, "-"], #  73
	[15, 23,   16.400, "-"], #  74
	[23,  9,   18.540, "-"], #  75
	[23, 22,   18.540, "-"], #  76
	[23, 29,   16.400, "-"], #  77
	[23, 24,   18.540, "-"], #  78
	[24, 15,   16.400, "-"], #  79
	[29, 35,   16.400, "-"], #  80
	[35, 23,   18.540, "-"], #  81
	[35, 24,   18.540, "-"], #  82
	[35, 30,   16.400, "-"], #  83
	[30, 24,   16.400, "-"], #  84
	[10, 24,   18.540, "-"], #  85
	[11, 25,   16.400, "-"], #  86
	[25, 10,   18.540, "-"], #  87
	[25, 24,   18.540, "-"], #  88
	[25, 30,   16.400, "-"], #  89
	[16, 25,   18.540, "-"], #  90
	[26, 31,   16.400, "-"], #  91
	[31, 16,   18.540, "-"], #  92
	[31, 25,   18.540, "-"], #  93
	[31, 30,   16.400, "-"]  #  94
        ]

# Faces: 60
F = [
	[ 0,  1,  2], #  0 
	[ 1, 11,  6], #  1 
	[ 1,  6,  2], #  2 
	[ 2,  6, 12], #  3 
	[ 0,  2,  3], #  4 
	[ 2, 12,  7], #  5 
	[ 2,  7,  3], #  6 
	[ 3,  7, 13], #  7 
	[ 0,  3,  4], #  8 
	[ 3, 13,  8], #  9 
	[ 3,  8,  4], # 10 
	[ 4,  8, 14], # 11 
	[ 0,  4,  5], # 12 
	[ 4, 14,  9], # 13 
	[ 4,  9,  5], # 14 
	[ 5,  9, 15], # 15 
	[ 0,  5,  1], # 16 
	[ 5, 15, 10], # 17 
	[ 5, 10,  1], # 18 
	[ 1, 10, 11], # 19 
	[11,  6, 16], # 20 
	[ 6, 12, 17], # 21 
	[ 6, 17, 16], # 22 
	[16, 17, 26], # 23 
	[12, 17, 18], # 24 
	[17, 26, 32], # 25 
	[17, 32, 18], # 26 
	[18, 32, 27], # 27 
	[12,  7, 18], # 28 
	[ 7, 13, 19], # 29 
	[ 7, 19, 18], # 30 
	[18, 19, 27], # 31 
	[13, 19, 20], # 32 
	[19, 27, 33], # 33 
	[19, 33, 20], # 34 
	[20, 33, 28], # 35 
	[13,  8, 20], # 36 
	[ 8, 14, 21], # 37 
	[ 8, 21, 20], # 38 
	[20, 21, 28], # 39 
	[14, 21, 22], # 40 
	[21, 28, 34], # 41 
	[21, 34, 22], # 42 
	[22, 34, 29], # 43 
	[14,  9, 22], # 44 
	[ 9, 15, 23], # 45 
	[ 9, 23, 22], # 46 
	[22, 23, 29], # 47 
	[15, 23, 24], # 48 
	[23, 29, 35], # 49 
	[23, 35, 24], # 50 
	[24, 35, 30], # 51 
	[15, 10, 24], # 52 
	[10, 11, 25], # 53 
	[10, 25, 24], # 54 
	[24, 25, 30], # 55 
	[11, 16, 25], # 56 
	[16, 26, 31], # 57 
	[16, 31, 25], # 58 
	[25, 31, 30]  # 59 
        ]

# Edge types: 2
ET = [
	[16.4, 1, 1, 0, 0, 50], #0 
	[18.54, 2, 0, 1, 0, 45] #1 
        ]


from sortedome import *

global max_dst

# Unique Vertex
class UniqueVertex:
        ''' It contains all 3-dimensional information to build hub model.
                p: Point(x, y, z) 
                level: a level that contains the vertices which have the same
                     height 
                level_size: number of vertices in a level 
                rid: index of the vertex in a level  
                uid: unique index of each vertex 
        '''
        Level = None   # VertexLevel object 

        def __init__(self, pt, uid, rid, level, level_size):
                self.uid = uid
                self.point = pt
                self.level = level
                self.level_size = level_size
                self.rid = rid 

        def get_uid(self, level, level_size, rid):
                pass

        def __str__(self):
                x, y, z = self.point.xyz()
                pt = '({}, {}, {})'.format(x, y, z) 
                text = 'uVertex<{}, {}, {}, {}, {}>'.format(
                                self.uid,
                                self.rid,
                                self.level,
                                self.level_size,
                                pt)
                return text

#
# Frequency 2, 36 vertices  
#
# 0 [0]
# 1 [1, 2, 3, 4, 5]
# 2 [6, 7, 8, 9, 10]
# 3 [11, 12, 13, 14, 15]
# 4 [16, 17, 18, 19, 20, 21, 22, 23, 24, 25]
# 5 [26, 27, 28, 29, 30]
# 6 [31, 32, 33, 34, 35]
#
# The layout of vertices in 2nd and 3rd level on XY plane
#
#     7     2     6
#                 
#      3    0   1
#   8              10 
#        4     5
#            
#           9
#
class VertexLevel:
        ''' Store indices of ordered vertices by equal height 
                Level: dictionary  
        '''

        def __init__(self, vsrc):
                self.Level = self.create_levels(vsrc) 
                self.size = len(self.Level)
                self.uVertex = self.generate_uvertex(vsrc) 

        #  [   0.000,    0.000,   30.000], #  0 0-0
        def create_levels(self, vsrc):
                tt, t, i = list(), list(), 0
                level = 0
                oldz = vsrc[0][2] 
                for i in range(len(vsrc)):
                        _curr = vsrc[i]
                        currz = _curr[-1]
                        index = i 
                        if oldz != currz:
                                level += 1
                                tt.append(t[:])
                                del t[:]
                        t.append(index)
                        oldz = currz
                tt.append(t[:])         # last element 

                d = dict()
                for i in range(len(tt)):
                        key = i
                        val = tt[i]     # a level 
                        d[key] = val 
                del t[:], tt[:]

                return d 

        def get_level(self, pos):
                if pos in self.Level.keys():
                        return self.Level[pos]

        def show(self):
                print('{} levels'.format(self.size))
                print('key size  data')
                print('--------------')
                for key, val in self.Level.items():
                        print('{:3d}  {:3d}  {}'.format(key, len(val), val))

        def get_rid(self, uid):
                ''' uid: Unique index 
                    Return triple: rid, level, size
                        rid: relative id of the vertex in a level
                        level: the level number 
                        size: size of the level
                '''
                i, pos, size, found = 0, 0, 0, False
                rid = 0
                while i < self.size and not found:
                        tmp = self.get_level(i)
                        j, size = 0, len(tmp)
                        while j < size:
                                if uid == pos:
                                        found = True
                                        rid = j
                                        break
                                else:
                                        pos += 1
                                j += 1
                        i += 1 

                level = 0 if i is 0 else i-1 
                ECHO('uid: {}, pos: {}'.format(uid, pos), False)
                ECHO('level: {}, rid: {}, size: {}'.format(level, rid, size),
                                False)
                return rid, level, size
       
        def uvertex(self, uid, triple):
                x, y, z = triple
                p = Point(x, y, z, prec=3)
                rid, l, sz = self.get_rid(uid)
                return UniqueVertex(p, uid, rid, l, sz)

        def generate_uvertex(self, vsrc):
                t = list()
                for uid in range(len(vsrc)):
                        uv = self.uvertex(uid, vsrc[uid])
                        t.append(uv)

                return t 

#
# Hub is basic data type to create 3D hub model.  
# A hub contains vectors that represent spokes, bend angles, and acute angles.
#
# Outer vertices and one center vertex forms one hub
# Each spoke, i.e 0-1, has one bend angle. 
#
# First hub whose uid is 0:  
# vector(0, 1), vector(0, 2), vector(0, 3)
# vector(0, 4), vector(0, 5)
#
#            2 
#                  
#                  
#     3             1  
#            0     
# 
#      
#       4         5 
#
#
# A hub has 3 to 6 acute angles firmed by spokes. 
# Each spoke maps to unique vector created by two vertices.
# Below is the 2nd hub, has 6 spokes:
# vector(1, 0), vector(1, 2), vector(1, 5), 
# vector(1, 6), vector(1, 10), vector(1, 11).
# These vectors firm 6 acute angles. 
# angle_0: vector(1, 0), vector(1, 2)
# angle_1: vector(1, 2), vector(1, 6) 
# angle_2: vector(1, 6), vector(1, 11)
# angle_3: vector(1, 11), vector(1, 10)
# angle_4: vector(1, 10), vector(1, 5)
# angle_5: vector(1, 5), vector(1, 0)
#
#       6
#  2        11
#       1
#  0        10
#       5
#

class Hub:
        ''' uid: unique index of the center vertice 
            spokes: indices of the outer vertices in list 
        '''
        def __init__(self, uid, spokes):
                self.uid = uid          # center 
                self.Spoke = spokes 


#ET = [
#        [16.4, 1, 1, 0, 0, 50], #0 
#        [18.54, 2, 0, 1, 0, 45] #1 
#        ]
def max_distance(esrc):
        ''' Find maxium distance '''
        t = list()
        for i in range(len(esrc)):
                d = esrc[i][0]
                t.append(d)
        t.sort()

        # last item is the biggest  
        return t[-1]  

# How to calculate the range of vertices in a level? 
def get_all_vertices(index, level, uV):
        if type(level) is type([]):
                start = level[0]
                end = level[-1]
                ECHO("get_all_vertices():{}-({}, {})".format(index, start,
                                        end), False)
                end += 1
                return uV[start:end]

                
# targets are keys 
# L is dictionary 
def find_ajacent_vertex(uid, targets, L, uV):
        global max_dst

        center = uV[uid]
        others = list()

        # Create one list 
        for key in targets:
                row = get_all_vertices(key, L[key], uV)
                others.extend(row)                        

        # Find 4 to 6 ajacent vertices 
        av = list()
        # limit = max_dst * 1.5
        for v in others:
                d = ptDist(center.point, v.point, prec=2)
                if d <= max_dst:
                        print('\t[{}]: {} vs {}'.format(v.uid, d, max_dst))
                        av.append(v)
        av.remove(center)

        print('Center vertex is {}'.format(uid))
        print('Ajacent vertices: ') 
        for v in av:
                print(v.uid, end=' ')


def create_hub(uid, L, uV):
        spk = list() 
        targets = list()
        the_end = len(L) - 1

        # Find the level that contains uid
        for it in uV:
                if uid is it.uid:
                       curr = it.level
                       break

        # Exclusive two levels: top and bottom 
        if curr is 0:
                targets.append(curr)
                targets.append(curr+1)
        elif curr is the_end:
                targets.append(curr-2)
                targets.append(curr-1)
                targets.append(curr)
        else:
                if curr-2 > 0:
                        targets.append(curr-2)
                targets.append(curr-1)
                targets.append(curr)
                targets.append(curr+1)
                if curr+2 <= the_end:
                        targets.append(curr+2)
         
        # Find ajacent vertices 
        find_ajacent_vertex(uid, targets, L, uV)

# bend_angle(), bend_angle2() 
# a, b: UniqueVertex objects
def test_func(a, b):
        a1 = bend_angle(a.point, b.point)
        a2 = bend_angle2(a.point, b.point)
        print('bend_angle(): ', a1)
        print('bend_angle2(): ', a2)

        
        
max_dst = max_distance(ET)
vL = VertexLevel(V)


